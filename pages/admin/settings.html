<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin ¬∑ Site Settings</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            kkpink: '#ff69b4',
          }
        }
      }
    }
  </script>

  <!-- KK base + components -->
  <link rel="stylesheet" href="/css/theme/base.css">
  <link rel="stylesheet" href="/css/theme/components.css">

  <style>
    /* Mobile improvements */
    @media (max-width: 640px) {
      button, [role="button"] { min-height: 44px; }
      input, select, textarea { font-size: 16px !important; }
    }

    /* Toggle switch */
    .toggle-switch {
      position: relative;
      width: 56px;
      height: 32px;
      background: #e5e7eb;
      border-radius: 9999px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .toggle-switch.active { background: #000; }
    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: #fff;
      border-radius: 9999px;
      transition: transform 0.2s;
    }
    .toggle-switch.active::after {
      transform: translateX(24px);
    }
  </style>
</head>

<body class="kk-page kk-admin bg-gray-50 min-h-screen">
  <!-- Admin Nav mount -->
  <div id="kkAdminNavMount"></div>

  <main class="max-w-4xl mx-auto px-2 sm:px-6 py-4 sm:py-8">

    <!-- Header Card -->
    <header class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 sm:p-6 mb-4 sm:mb-6 text-center">
      <div class="inline-block bg-black text-white px-2 py-1 text-[10px] font-black uppercase tracking-[.25em] mb-2">
        Admin Panel
      </div>
      <h1 class="text-2xl sm:text-4xl font-black tracking-tight">
        Site Settings
      </h1>
      <p class="text-xs sm:text-sm text-gray-500 mt-1">
        Manage announcement bar, shipping settings, and more
      </p>
    </header>

    <!-- APP -->
    <section id="appPanel" class="hidden space-y-4 sm:space-y-6">

      <!-- Announcement Bar Section -->
      <section class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 sm:p-6">
        <div class="flex items-start justify-between gap-4 mb-6">
          <div>
            <h2 class="text-lg sm:text-xl font-black flex items-center gap-2">
              <span>üì¢</span> Announcement Bar
            </h2>
            <p class="text-xs sm:text-sm text-gray-500 mt-1">Display a message at the top of your site</p>
          </div>
          <div
            id="announcementToggle"
            class="toggle-switch"
            role="switch"
            aria-checked="false"
            tabindex="0"
          ></div>
          <input type="checkbox" id="announcementEnabled" class="hidden">
        </div>

        <div class="space-y-4">
          <!-- Text -->
          <div>
            <label for="announcementText" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
              Announcement Text
            </label>
            <input
              id="announcementText"
              type="text"
              placeholder="FREE SHIPPING on orders over $50!"
              class="w-full border-[4px] border-black px-3 py-2 sm:py-3 text-sm outline-none focus:border-kkpink transition-colors"
            />
          </div>

          <!-- Link (Optional) -->
          <div>
            <label for="announcementLink" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
              Link (Optional)
            </label>
            <input
              id="announcementLink"
              type="text"
              placeholder="/pages/catalog.html or https://..."
              class="w-full border-[4px] border-black px-3 py-2 sm:py-3 text-sm outline-none focus:border-kkpink transition-colors"
            />
            <p class="text-xs text-gray-400 mt-1">Leave empty for no link</p>
          </div>

          <!-- Colors -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                Background Color
              </label>
              <div class="flex gap-2">
                <input
                  id="announcementBgColor"
                  type="color"
                  value="#000000"
                  class="w-12 h-12 border-4 border-black cursor-pointer"
                />
                <input
                  id="announcementBgColorText"
                  type="text"
                  value="#000000"
                  class="flex-1 border-4 border-black px-3 py-2 text-sm uppercase outline-none focus:border-kkpink transition-colors"
                />
              </div>
            </div>
            <div>
              <label class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                Text Color
              </label>
              <div class="flex gap-2">
                <input
                  id="announcementTextColor"
                  type="color"
                  value="#ffffff"
                  class="w-12 h-12 border-4 border-black cursor-pointer"
                />
                <input
                  id="announcementTextColorText"
                  type="text"
                  value="#ffffff"
                  class="flex-1 border-4 border-black px-3 py-2 text-sm uppercase outline-none focus:border-kkpink transition-colors"
                />
              </div>
            </div>
          </div>

          <!-- Show Close Button -->
          <div class="flex items-center gap-3">
            <input type="checkbox" id="announcementShowClose" checked class="w-5 h-5 accent-black border-2 border-black">
            <label for="announcementShowClose" class="text-sm font-bold">Allow visitors to dismiss the bar</label>
          </div>

          <!-- Preview -->
          <div>
            <label class="block text-[11px] font-black uppercase tracking-[.12em] mb-2 text-black/70">
              Preview
            </label>
            <div id="announcementPreview" class="border-4 border-black overflow-hidden rounded-lg">
              <div class="flex items-center justify-center gap-4 py-3 px-4 text-center text-sm font-bold" style="background: #000; color: #fff;">
                <span id="previewText">FREE SHIPPING on orders over $50!</span>
                <button class="opacity-60 hover:opacity-100 text-lg leading-none">‚úï</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Free Shipping Progress Section -->
      <section class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 sm:p-6">
        <div class="flex items-start justify-between gap-4 mb-6">
          <div>
            <h2 class="text-lg sm:text-xl font-black flex items-center gap-2">
              <span>üöö</span> Free Shipping Progress
            </h2>
            <p class="text-xs sm:text-sm text-gray-500 mt-1">Show progress bar in cart drawer</p>
          </div>
          <div
            id="freeShippingToggle"
            class="toggle-switch active"
            role="switch"
            aria-checked="true"
            tabindex="0"
          ></div>
          <input type="checkbox" id="freeShippingEnabled" checked class="hidden">
        </div>

        <div class="space-y-4">
          <!-- Threshold -->
          <div>
            <label for="freeShippingThreshold" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
              Free Shipping Threshold ($)
            </label>
            <div class="relative w-full sm:w-48">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
              <input
                id="freeShippingThreshold"
                type="number"
                min="0"
                step="0.01"
                value="50.00"
                placeholder="50.00"
                class="w-full border-[4px] border-black pl-7 pr-3 py-2 sm:py-3 text-sm outline-none focus:border-kkpink transition-colors"
              />
            </div>
            <p class="text-xs text-gray-400 mt-1">Orders at or above this amount get free shipping</p>
          </div>

          <!-- Message Under Threshold -->
          <div>
            <label for="freeShippingMsgUnder" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
              Message (Under Threshold)
            </label>
            <input
              id="freeShippingMsgUnder"
              type="text"
              value="Spend ${remaining} more for FREE shipping!"
              placeholder="Spend ${remaining} more for FREE shipping!"
              class="w-full border-[4px] border-black px-3 py-2 sm:py-3 text-sm outline-none focus:border-kkpink transition-colors"
            />
            <p class="text-xs text-gray-400 mt-1">Use ${remaining} as placeholder for remaining amount</p>
          </div>

          <!-- Message When Reached -->
          <div>
            <label for="freeShippingMsgReached" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
              Message (Threshold Reached)
            </label>
            <input
              id="freeShippingMsgReached"
              type="text"
              value="üéâ You qualify for FREE shipping!"
              placeholder="üéâ You qualify for FREE shipping!"
              class="w-full border-[4px] border-black px-3 py-2 sm:py-3 text-sm outline-none focus:border-kkpink transition-colors"
            />
          </div>

          <!-- Preview -->
          <div>
            <label class="block text-[11px] font-black uppercase tracking-[.12em] mb-2 text-black/70">
              Preview (Under Threshold)
            </label>
            <div class="border-4 border-black p-4 bg-gray-50 rounded-lg">
              <div class="text-sm font-bold text-center mb-2">Spend $25.00 more for FREE shipping!</div>
              <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full bg-black rounded-full transition-all" style="width: 50%"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Save Button -->
      <div class="flex justify-end gap-3">
        <button
          id="btnSave"
          type="button"
          class="border-4 border-black bg-black text-white px-8 py-3 font-black uppercase tracking-[.12em] text-sm
                 hover:bg-kkpink hover:border-kkpink hover:text-black transition-all"
        >
          üíæ Save Settings
        </button>
      </div>

    </section>

    <!-- Loading State -->
    <section id="loadingPanel" class="mt-8">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 text-center">
        <div class="inline-block w-8 h-8 border-4 border-black border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-sm text-gray-500">Loading settings...</p>
      </div>
    </section>

  </main>

  <!-- Footer mount -->
  <div id="kkFooterMount"></div>

  <script type="module">
    import { initAdminNav } from "/js/shared/adminNav.js";
    import { initFooter } from "/js/shared/footer.js";
    import { getSupabaseClient } from "/js/shared/supabaseClient.js";
    import { requireAdmin } from "/js/shared/guard.js";

    const supabase = getSupabaseClient();

    // DOM Elements
    const appPanel = document.getElementById("appPanel");
    const loadingPanel = document.getElementById("loadingPanel");

    // Announcement Bar
    const announcementEnabled = document.getElementById("announcementEnabled");
    const announcementToggle = document.getElementById("announcementToggle");
    const announcementText = document.getElementById("announcementText");
    const announcementLink = document.getElementById("announcementLink");
    const announcementBgColor = document.getElementById("announcementBgColor");
    const announcementBgColorText = document.getElementById("announcementBgColorText");
    const announcementTextColor = document.getElementById("announcementTextColor");
    const announcementTextColorText = document.getElementById("announcementTextColorText");
    const announcementShowClose = document.getElementById("announcementShowClose");
    const announcementPreview = document.getElementById("announcementPreview");
    const previewText = document.getElementById("previewText");

    // Free Shipping
    const freeShippingEnabled = document.getElementById("freeShippingEnabled");
    const freeShippingToggle = document.getElementById("freeShippingToggle");
    const freeShippingThreshold = document.getElementById("freeShippingThreshold");
    const freeShippingMsgUnder = document.getElementById("freeShippingMsgUnder");
    const freeShippingMsgReached = document.getElementById("freeShippingMsgReached");

    const btnSave = document.getElementById("btnSave");

    // Toggle switch helpers
    function setupToggle(toggle, checkbox) {
      const update = () => {
        if (checkbox.checked) {
          toggle.classList.add("active");
          toggle.setAttribute("aria-checked", "true");
        } else {
          toggle.classList.remove("active");
          toggle.setAttribute("aria-checked", "false");
        }
      };
      
      toggle.addEventListener("click", () => {
        checkbox.checked = !checkbox.checked;
        update();
      });
      
      toggle.addEventListener("keydown", (e) => {
        if (e.key === " " || e.key === "Enter") {
          e.preventDefault();
          checkbox.checked = !checkbox.checked;
          update();
        }
      });
      
      // Initial state
      update();
    }

    async function init() {
      await initAdminNav("Settings");
      initFooter();
      
      // Admin guard
      const check = await requireAdmin();
      if (!check.ok) {
        console.warn("[Settings] Not admin:", check.reason);
      }
      
      // Setup toggle switches
      setupToggle(announcementToggle, announcementEnabled);
      setupToggle(freeShippingToggle, freeShippingEnabled);
      
      await loadSettings();
      setupListeners();
      loadingPanel.classList.add("hidden");
      appPanel.classList.remove("hidden");
    }

    async function loadSettings() {
      // Fetch announcement bar settings
      const { data: announcementData } = await supabase
        .from("site_settings")
        .select("value")
        .eq("key", "announcement_bar")
        .single();

      if (announcementData?.value) {
        const v = announcementData.value;
        announcementEnabled.checked = v.enabled ?? false;
        announcementToggle.classList.toggle("active", v.enabled ?? false);
        announcementToggle.setAttribute("aria-checked", String(v.enabled ?? false));
        announcementText.value = v.text ?? "";
        announcementLink.value = v.link ?? "";
        announcementBgColor.value = v.bg_color ?? "#000000";
        announcementBgColorText.value = v.bg_color ?? "#000000";
        announcementTextColor.value = v.text_color ?? "#ffffff";
        announcementTextColorText.value = v.text_color ?? "#ffffff";
        announcementShowClose.checked = v.show_close ?? true;
        updatePreview();
      }

      // Fetch free shipping settings
      const { data: freeShippingData } = await supabase
        .from("site_settings")
        .select("value")
        .eq("key", "free_shipping")
        .single();

      if (freeShippingData?.value) {
        const v = freeShippingData.value;
        freeShippingEnabled.checked = v.enabled ?? true;
        freeShippingToggle.classList.toggle("active", v.enabled ?? true);
        freeShippingToggle.setAttribute("aria-checked", String(v.enabled ?? true));
        freeShippingThreshold.value = v.threshold ?? 50;
        freeShippingMsgUnder.value = v.message_under ?? "Spend ${remaining} more for FREE shipping!";
        freeShippingMsgReached.value = v.message_reached ?? "üéâ You qualify for FREE shipping!";
      }
    }

    function setupListeners() {
      // Sync color pickers with text inputs
      announcementBgColor.addEventListener("input", () => {
        announcementBgColorText.value = announcementBgColor.value;
        updatePreview();
      });
      announcementBgColorText.addEventListener("input", () => {
        if (/^#[0-9A-Fa-f]{6}$/.test(announcementBgColorText.value)) {
          announcementBgColor.value = announcementBgColorText.value;
        }
        updatePreview();
      });
      announcementTextColor.addEventListener("input", () => {
        announcementTextColorText.value = announcementTextColor.value;
        updatePreview();
      });
      announcementTextColorText.addEventListener("input", () => {
        if (/^#[0-9A-Fa-f]{6}$/.test(announcementTextColorText.value)) {
          announcementTextColor.value = announcementTextColorText.value;
        }
        updatePreview();
      });

      announcementText.addEventListener("input", updatePreview);

      btnSave.addEventListener("click", saveSettings);
    }

    function updatePreview() {
      const bar = announcementPreview.querySelector("div");
      bar.style.background = announcementBgColor.value;
      bar.style.color = announcementTextColor.value;
      previewText.textContent = announcementText.value || "Your announcement text here";
    }

    async function saveSettings() {
      btnSave.disabled = true;
      btnSave.textContent = "Saving...";

      try {
        // Save announcement bar
        const { error: err1 } = await supabase
          .from("site_settings")
          .upsert({
            key: "announcement_bar",
            value: {
              enabled: announcementEnabled.checked,
              text: announcementText.value,
              link: announcementLink.value,
              bg_color: announcementBgColor.value,
              text_color: announcementTextColor.value,
              show_close: announcementShowClose.checked
            },
            updated_at: new Date().toISOString()
          }, { onConflict: "key" });

        if (err1) throw err1;

        // Save free shipping
        const { error: err2 } = await supabase
          .from("site_settings")
          .upsert({
            key: "free_shipping",
            value: {
              enabled: freeShippingEnabled.checked,
              threshold: parseFloat(freeShippingThreshold.value) || 50,
              message_under: freeShippingMsgUnder.value,
              message_reached: freeShippingMsgReached.value
            },
            updated_at: new Date().toISOString()
          }, { onConflict: "key" });

        if (err2) throw err2;

        alert("‚úÖ Settings saved successfully!");
      } catch (err) {
        console.error(err);
        alert("‚ùå Error saving settings: " + err.message);
      } finally {
        btnSave.disabled = false;
        btnSave.textContent = "üíæ Save Settings";
      }
    }

    init();
  </script>
</body>
</html>
