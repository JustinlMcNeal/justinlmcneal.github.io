<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin ¬∑ Orders</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            kkpink: '#ff69b4',
          }
        }
      }
    }
  </script>

  <!-- KK base + components -->
  <link rel="stylesheet" href="/css/theme/base.css">
  <link rel="stylesheet" href="/css/theme/components.css">

  <style>
    /* Custom scrollbar for tables */
    .custom-scrollbar::-webkit-scrollbar { height: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #000; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #333; }

    /* Row hover effect */
    .order-row:hover { background: #fafafa; }
    .order-row:hover .row-actions { opacity: 1; }
    .row-actions { opacity: 0.5; transition: opacity 0.15s; }

    /* Status badges */
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-label_purchased { background: #dbeafe; color: #1e40af; }
    .status-shipped { background: #ede9fe; color: #5b21b6; }
    .status-delivered { background: #d1fae5; color: #065f46; }
    .status-voided { background: #fee2e2; color: #991b1b; }
    .status-returned { background: #f3f4f6; color: #374151; }

    /* Drop zone styling */
    .drop-zone.is-drop-active {
      border-color: #10b981 !important;
      background: #d1fae5 !important;
      color: #065f46 !important;
      animation: pulse-border 0.5s ease-in-out infinite alternate;
    }
    @keyframes pulse-border {
      from { border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
      to { border-color: #059669; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.3); }
    }

    /* Mobile improvements */
    @media (max-width: 640px) {
      button, [role="button"] { min-height: 44px; }
      input, select, textarea { font-size: 16px !important; }
    }
  </style>
</head>

<body class="kk-page kk-admin bg-gray-50 min-h-screen">
  <!-- Admin Nav mount -->
  <div id="kkAdminNavMount"></div>

  <main class="max-w-7xl mx-auto px-2 sm:px-6 py-4 sm:py-8">

    <!-- Header Card -->
    <header class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 sm:p-6 mb-4 sm:mb-6">
      <div class="flex flex-col gap-4">
        <div>
          <div class="inline-block bg-black text-white px-2 py-1 text-[10px] font-black uppercase tracking-[.25em] mb-2">
            Admin Panel
          </div>
          <h1 class="text-2xl sm:text-4xl font-black tracking-tight">
            Orders
          </h1>
          <p class="text-xs sm:text-sm text-gray-500 mt-1">
            Grouped orders view for totals, status, shipping, profit, and exports
          </p>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-2">
          <div class="bg-gray-50 rounded-xl p-3 sm:p-4 border border-gray-100">
            <div class="text-[9px] sm:text-[10px] font-black uppercase tracking-[.18em] text-gray-500">Orders</div>
            <div id="kpiOrders" class="text-lg sm:text-2xl font-black mt-1">‚Äî</div>
          </div>
          <div class="bg-gray-50 rounded-xl p-3 sm:p-4 border border-gray-100">
            <div class="text-[9px] sm:text-[10px] font-black uppercase tracking-[.18em] text-gray-500">Revenue</div>
            <div id="kpiRevenue" class="text-lg sm:text-2xl font-black mt-1 text-green-600">‚Äî</div>
          </div>
          <div class="bg-gray-50 rounded-xl p-3 sm:p-4 border border-gray-100">
            <div class="text-[9px] sm:text-[10px] font-black uppercase tracking-[.18em] text-gray-500">Profit</div>
            <div id="kpiProfit" class="text-lg sm:text-2xl font-black mt-1 text-emerald-600">‚Äî</div>
          </div>
          <div class="bg-gray-50 rounded-xl p-3 sm:p-4 border border-gray-100">
            <div class="text-[9px] sm:text-[10px] font-black uppercase tracking-[.18em] text-gray-500">Unfulfilled</div>
            <div id="kpiUnfulfilled" class="text-lg sm:text-2xl font-black mt-1 text-amber-600">‚Äî</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Filters Section -->
    <section class="bg-white rounded-2xl shadow-sm border border-gray-200 p-3 sm:p-4 mb-4 sm:mb-6">
      <div class="text-[11px] font-black uppercase tracking-[.25em] text-gray-400 mb-3">Filters</div>

      <div class="grid gap-3 md:grid-cols-2">
        <!-- Search -->
        <div>
          <label for="searchInput"
                 class="block text-[9px] sm:text-[10px] font-black uppercase tracking-[.18em] mb-1 sm:mb-2 text-gray-500">
            Search
          </label>
          <div class="relative">
            <input
              id="searchInput"
              type="search"
              placeholder="Order / email / name / coupon / tracking..."
              autocomplete="off"
              class="w-full border-4 border-black px-3 sm:px-4 py-2 sm:py-3 text-sm outline-none pr-10 focus:border-kkpink transition-colors"
            />
            <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
        </div>

        <!-- Status -->
        <div>
          <label for="statusFilter"
                 class="block text-[9px] sm:text-[10px] font-black uppercase tracking-[.18em] mb-1 sm:mb-2 text-gray-500">
            Status
          </label>
          <select id="statusFilter" class="w-full border-4 border-black px-3 py-2 sm:py-3 text-sm outline-none bg-white focus:border-kkpink transition-colors">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="label_purchased">Label Purchased</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
            <option value="voided">Voided</option>
            <option value="returned">Returned</option>
          </select>
        </div>
      </div>

      <div class="grid gap-3 mt-3 md:grid-cols-3 items-end">
        <!-- Date From -->
        <div>
          <label for="dateFrom"
                 class="block text-[9px] sm:text-[10px] font-black uppercase tracking-[.18em] mb-1 sm:mb-2 text-gray-500">
            Date From
          </label>
          <input id="dateFrom" type="date" class="w-full border-4 border-black px-3 py-2 sm:py-3 text-sm outline-none focus:border-kkpink transition-colors" />
        </div>

        <!-- Date To -->
        <div>
          <label for="dateTo"
                 class="block text-[9px] sm:text-[10px] font-black uppercase tracking-[.18em] mb-1 sm:mb-2 text-gray-500">
            Date To
          </label>
          <input id="dateTo" type="date" class="w-full border-4 border-black px-3 py-2 sm:py-3 text-sm outline-none focus:border-kkpink transition-colors" />
        </div>

        <!-- Actions -->
        <div class="flex flex-col gap-2">
          <button
            id="btnRefresh"
            type="button"
            class="border-4 border-black bg-black text-white px-4 py-2 sm:py-3 font-black uppercase tracking-[.12em] text-xs
                   hover:bg-white hover:text-black transition-all"
          >
            Refresh
          </button>
          <div class="flex items-center justify-between text-xs text-gray-500">
            <span id="countLabel">0 rows</span>
            <span id="status"></span>
          </div>
        </div>
      </div>

      <!-- Export Buttons -->
      <div class="border-t border-gray-200 mt-4 pt-4">
        <div class="flex flex-wrap gap-2 items-center">
          <button
            id="btnExportShipReady"
            type="button"
            class="border-4 border-black bg-white text-black px-4 py-2 font-black uppercase tracking-[.12em] text-[10px]
                   hover:bg-black hover:text-white transition-all"
          >
            üì¶ Export Ship-Ready CSV
          </button>

          <button
            id="btnImportPirateShip"
            type="button"
            class="border-4 border-black bg-white text-black px-4 py-2 font-black uppercase tracking-[.12em] text-[10px]
                   hover:bg-black hover:text-white transition-all
                   drop-zone"
          >
            üè¥‚Äç‚ò†Ô∏è Import Pirate Ship
          </button>

          <span class="text-xs text-gray-400 ml-2">Click or drag & drop CSV</span>
        </div>
        
        <!-- Import Result Panel (hidden by default) -->
        <div id="importResultPanel" class="hidden mt-4 p-4 border-4 border-emerald-500 bg-emerald-50 rounded-lg">
          <div class="flex items-start gap-3">
            <div class="text-2xl">‚úÖ</div>
            <div class="flex-1">
              <div class="font-black text-emerald-800">Import Complete</div>
              <div class="grid grid-cols-2 gap-4 mt-2 text-sm">
                <div>
                  <span class="text-emerald-600">Updated:</span>
                  <span id="importUpdatedCount" class="font-bold">0</span>
                </div>
                <div>
                  <span class="text-gray-500">Skipped:</span>
                  <span id="importSkippedCount" class="font-bold">0</span>
                </div>
              </div>
              <div class="text-xs text-emerald-600 mt-2">
                Batch ID: <code id="importBatchId" class="bg-emerald-100 px-1 py-0.5 rounded"></code>
              </div>
            </div>
            <button id="importResultClose" type="button" class="text-emerald-600 hover:text-emerald-800 text-lg font-bold">√ó</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Table -->
    <section id="tableWrap" class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
      <!-- Mobile Card View -->
      <div id="mobileOrderCards" class="sm:hidden"></div>

      <!-- Desktop Table View -->
      <div class="hidden sm:block overflow-x-auto custom-scrollbar">
        <table id="ordersTable" class="w-full border-collapse text-sm">
          <thead class="bg-black text-white">
            <tr class="text-left uppercase tracking-[.12em] text-[11px] font-black">
              <th class="px-4 py-4">Date</th>
              <th class="px-4 py-4">Order</th>
              <th class="px-4 py-4">Customer</th>
              <th class="px-4 py-4 text-center">Items</th>
              <th class="px-4 py-4 text-right">Paid</th>
              <th class="px-4 py-4 text-right">Profit</th>
              <th class="px-4 py-4">Status</th>
              <th class="px-4 py-4 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="ordersRows" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="hidden p-8 text-center">
        <div class="text-4xl mb-3">üìã</div>
        <div class="text-gray-500 text-sm">No orders found</div>
      </div>

      <!-- Load More -->
      <div class="p-4 border-t border-gray-200 flex items-center justify-between">
        <div id="loadMoreStatus" class="text-xs text-gray-500"></div>
        <button id="btnLoadMore" type="button"
          class="border-4 border-black bg-white text-black px-4 py-2 font-black uppercase tracking-[.12em] text-xs
                 hover:bg-black hover:text-white transition-all">
          Load More ‚Üì
        </button>
      </div>
    </section>

  </main>

  <!-- EDIT MODAL -->
  <div id="modal" class="hidden fixed inset-0 z-[200]" aria-hidden="true">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-modal-close></div>

    <!-- Stage -->
    <div class="relative h-full w-full overflow-y-auto">
      <div class="min-h-full flex items-end sm:items-center justify-center p-0 sm:p-6">
        <!-- Card -->
        <div class="w-full sm:max-w-3xl bg-white border-0 sm:border-4 border-black shadow-none sm:shadow-[8px_8px_0_0_rgba(0,0,0,0.1)] min-h-screen sm:min-h-0">
          <!-- Head -->
          <div class="sticky top-0 z-10 flex items-center justify-between gap-3 p-3 sm:p-5 border-b-4 border-black bg-white">
            <div class="min-w-0">
              <div id="modalKicker" class="inline-block bg-blue-500 text-white px-2 py-0.5 text-[8px] sm:text-[9px] font-black uppercase tracking-[.2em] mb-1">
                Order
              </div>
              <h3 id="modalTitle" class="text-lg sm:text-2xl font-black tracking-tight truncate">
                Edit Shipment
              </h3>
              <div id="modalSub" class="text-xs text-gray-500">Update label + tracking info</div>
            </div>

            <button
              id="btnClose"
              type="button"
              class="border-4 border-black bg-white w-10 h-10 flex items-center justify-center font-black text-lg
                     hover:bg-black hover:text-white transition-colors flex-shrink-0"
              aria-label="Close"
            >
              ‚úï
            </button>
          </div>

          <!-- Body -->
          <div class="p-3 sm:p-6 space-y-6 pb-24 sm:pb-6">
            <!-- Message -->
            <div id="modalMsg" class="hidden p-3 border-4 border-red-300 bg-red-50 text-red-700 text-sm"></div>

            <!-- Identifiers Section -->
            <section>
              <div class="text-[11px] font-black uppercase tracking-[.25em] flex items-center gap-2 mb-4">
                <span class="w-5 h-5 bg-black text-white text-[10px] flex items-center justify-center">1</span>
                Order Info
              </div>

              <div class="grid sm:grid-cols-2 gap-4">
                <div>
                  <label for="fSessionId" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                    Stripe Session ID
                  </label>
                  <input id="fSessionId" type="text" readonly class="w-full border-[4px] border-gray-300 bg-gray-50 px-3 py-2 text-sm outline-none" />
                </div>

                <div>
                  <label for="fKkOrderId" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                    KK Order ID
                  </label>
                  <input id="fKkOrderId" type="text" readonly class="w-full border-[4px] border-gray-300 bg-gray-50 px-3 py-2 text-sm outline-none" />
                </div>
              </div>
            </section>

            <div class="border-t-4 border-gray-100"></div>

            <!-- Shipment Section -->
            <section>
              <div class="text-[11px] font-black uppercase tracking-[.25em] flex items-center gap-2 mb-4">
                <span class="w-5 h-5 bg-black text-white text-[10px] flex items-center justify-center">2</span>
                Shipment Details
              </div>

              <div class="grid sm:grid-cols-2 gap-4">
                <div>
                  <label for="fLabelStatus" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                    Label Status
                  </label>
                  <select id="fLabelStatus" class="w-full border-[4px] border-black px-3 py-2 text-sm outline-none bg-white focus:border-kkpink transition-colors">
                    <option value="pending">Pending</option>
                    <option value="label_purchased">Label Purchased</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="voided">Voided</option>
                    <option value="returned">Returned</option>
                  </select>
                </div>

                <div>
                  <label for="fTrackingNumber" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                    Tracking Number
                  </label>
                  <input id="fTrackingNumber" type="text" placeholder="9400..." class="w-full border-[4px] border-black px-3 py-2 text-sm outline-none focus:border-kkpink transition-colors" />
                </div>

                <div>
                  <label for="fCarrier" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                    Carrier
                  </label>
                  <input id="fCarrier" type="text" placeholder="USPS / UPS / FedEx" class="w-full border-[4px] border-black px-3 py-2 text-sm outline-none focus:border-kkpink transition-colors" />
                </div>

                <div>
                  <label for="fService" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                    Service
                  </label>
                  <input id="fService" type="text" placeholder="Ground Advantage, Priority..." class="w-full border-[4px] border-black px-3 py-2 text-sm outline-none focus:border-kkpink transition-colors" />
                </div>

                <div>
                  <label for="fBatchId" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                    Batch ID
                  </label>
                  <input id="fBatchId" type="text" placeholder="2025-12-25-A" class="w-full border-[4px] border-black px-3 py-2 text-sm outline-none focus:border-kkpink transition-colors" />
                </div>

                <div>
                  <label for="fPrintedAt" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                    Printed At
                  </label>
                  <input id="fPrintedAt" type="datetime-local" class="w-full border-[4px] border-black px-3 py-2 text-sm outline-none focus:border-kkpink transition-colors" />
                </div>

                <div>
                  <label for="fLabelCost" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                    Label Cost ($)
                  </label>
                  <input id="fLabelCost" type="number" step="0.01" placeholder="4.23" class="w-full border-[4px] border-black px-3 py-2 text-sm outline-none focus:border-kkpink transition-colors" />
                </div>

                <div>
                  <label for="fPackageWeightGFinal" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                    Final Package Weight (g)
                  </label>
                  <input id="fPackageWeightGFinal" type="number" step="1" placeholder="320" class="w-full border-[4px] border-black px-3 py-2 text-sm outline-none focus:border-kkpink transition-colors" />
                </div>

                <div class="sm:col-span-2">
                  <label for="fPirateShipShipmentId" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                    Pirate Ship Shipment ID
                  </label>
                  <input id="fPirateShipShipmentId" type="text" placeholder="pship_..." class="w-full border-[4px] border-black px-3 py-2 text-sm outline-none focus:border-kkpink transition-colors" />
                </div>

                <div class="sm:col-span-2">
                  <label for="fNotes" class="block text-[11px] font-black uppercase tracking-[.12em] mb-1 text-black/70">
                    Notes
                  </label>
                  <textarea id="fNotes" rows="3" placeholder="Any fulfillment notes..." class="w-full border-[4px] border-black px-3 py-2 text-sm outline-none resize-y focus:border-kkpink transition-colors"></textarea>
                </div>
              </div>
            </section>
          </div>

          <!-- Foot -->
          <div class="sticky bottom-0 flex items-center justify-end gap-3 p-3 sm:p-5 border-t-4 border-black bg-gray-50">
            <button
              id="btnCancel"
              type="button"
              class="border-4 border-black bg-white text-black px-4 py-2 font-black uppercase tracking-[.12em] text-xs
                     hover:bg-gray-100 transition-all"
            >
              Cancel
            </button>
            <button
              id="btnSave"
              type="button"
              class="border-4 border-black bg-black text-white px-6 py-2 font-black uppercase tracking-[.12em] text-xs
                     hover:bg-kkpink hover:border-kkpink hover:text-black transition-all"
            >
              Save
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- VIEW DETAILS MODAL -->
  <div id="viewModal" class="hidden fixed inset-0 z-[200]" aria-hidden="true">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-view-modal-close></div>

    <!-- Stage -->
    <div class="relative h-full w-full overflow-y-auto">
      <div class="min-h-full flex items-end sm:items-center justify-center p-0 sm:p-6">
        <!-- Card -->
        <div class="w-full sm:max-w-4xl bg-white border-0 sm:border-4 border-black shadow-none sm:shadow-[8px_8px_0_0_rgba(0,0,0,0.1)] min-h-screen sm:min-h-0 sm:max-h-[90vh] overflow-y-auto">
          <!-- Head -->
          <div class="sticky top-0 z-10 flex items-center justify-between gap-3 p-3 sm:p-5 border-b-4 border-black bg-white">
            <div class="min-w-0">
              <div class="inline-block bg-green-500 text-white px-2 py-0.5 text-[8px] sm:text-[9px] font-black uppercase tracking-[.2em] mb-1">
                Order Details
              </div>
              <h3 id="viewModalTitle" class="text-lg sm:text-2xl font-black tracking-tight truncate">
                Loading...
              </h3>
            </div>

            <button
              id="btnViewClose"
              type="button"
              class="border-4 border-black bg-white w-10 h-10 flex items-center justify-center font-black text-lg
                     hover:bg-black hover:text-white transition-colors flex-shrink-0"
              aria-label="Close"
            >
              ‚úï
            </button>
          </div>

          <!-- Body -->
          <div id="viewModalBody" class="p-3 sm:p-6 space-y-6">
            <div class="text-center py-8 text-gray-500">Loading order details...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer mount -->
  <div id="kkFooterMount"></div>

  <!-- Click backdrop to close -->
  <script>
    (function () {
      const modal = document.getElementById("modal");
      const backdrop = modal?.querySelector("[data-modal-close]");
      const closeBtn = document.getElementById("btnClose");
      if (!modal || !backdrop || !closeBtn) return;
      backdrop.addEventListener("click", () => closeBtn.click());
    })();
    
    // View modal backdrop
    (function () {
      const modal = document.getElementById("viewModal");
      const backdrop = modal?.querySelector("[data-view-modal-close]");
      const closeBtn = document.getElementById("btnViewClose");
      if (!modal || !backdrop || !closeBtn) return;
      backdrop.addEventListener("click", () => closeBtn.click());
    })();
  </script>

  <script type="module" src="/js/admin/lineItemsOrders/index.js"></script>
</body>
</html>
